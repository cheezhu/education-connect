# Education Connect - å‰åç«¯äº¤äº’è¯¦è§£

## é¡¹ç›®æ¦‚è¿°

Education Connect æ˜¯ä¸€ä¸ªä¸“ä¸ºé¦™æ¸¯ç ”å­¦å›¢ç»„è®¾è®¡çš„è¡Œç¨‹ç®¡ç†ç³»ç»Ÿï¼Œé‡‡ç”¨ç°ä»£åŒ–çš„å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œæ”¯æŒå¤šå›¢ç»„å¹¶å‘ç®¡ç†ã€å¯è§†åŒ–æ—¥å†ã€æ‹–æ‹½æ“ä½œã€å®æ—¶æ•°æ®åŒæ­¥å’Œæ™ºèƒ½å†²çªæ£€æµ‹ã€‚

**æœ€æ–°æ›´æ–°æ—¶é—´**: 2025å¹´9æœˆ21æ—¥
**ç³»ç»Ÿç‰ˆæœ¬**: V1.8.4 (æ•°æ®åº“ç‰ˆæœ¬)

## æŠ€æœ¯æ¶æ„æ€»è§ˆ

### ğŸ¯ æ ¸å¿ƒæŠ€æœ¯æ ˆ

#### å‰ç«¯æŠ€æœ¯æ ˆ
- **æ¡†æ¶**: React 18 + Vite
- **UIç»„ä»¶åº“**: Ant Design 5.x
- **è·¯ç”±ç®¡ç†**: React Router DOM 6.x
- **HTTPå®¢æˆ·ç«¯**: Axios
- **æ—¥æœŸå¤„ç†**: Day.js
- **æ‹–æ‹½åŠŸèƒ½**: HTML5 Drag & Drop API
- **å¼€å‘æœåŠ¡å™¨**: Vite Dev Server
- **ç«¯å£**: http://localhost:5173

#### åç«¯æŠ€æœ¯æ ˆ
- **è¿è¡Œæ—¶**: Node.js + Express.js
- **æ•°æ®åº“**: SQLite
- **ORM**: Prisma Client
- **è®¤è¯æ–¹å¼**: HTTP Basic Authentication
- **CORS**: å¯ç”¨è·¨åŸŸæ”¯æŒ
- **ç«¯å£**: http://localhost:3002

#### æ•°æ®å­˜å‚¨æ¶æ„
- **æ•°æ®åº“ç±»å‹**: SQLite (æ–‡ä»¶å­˜å‚¨)
- **æ•°æ®åº“æ–‡ä»¶**: `backend/prisma/dev.db`
- **ORMå·¥å…·**: Prisma
- **ç®¡ç†ç•Œé¢**: Prisma Studio (ç«¯å£: 5555)
- **å­—æ®µæ˜ å°„**: camelCase (JS) â†” snake_case (DB)

### ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    HTTP/JSON    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    Prisma    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   React å‰ç«¯    â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ Express åç«¯    â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  SQLite æ•°æ®åº“  â”‚
â”‚  (Port: 5173)   â”‚     REST API    â”‚  (Port: 3002)   â”‚    ORM      â”‚  (dev.db æ–‡ä»¶)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘                                   â†‘                               â†‘
         â”‚                                   â”‚                               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Vite    â”‚                         â”‚ Prisma  â”‚                    â”‚ Prisma  â”‚
    â”‚ Dev     â”‚                         â”‚ Client  â”‚                    â”‚ Studio  â”‚
    â”‚ Server  â”‚                         â”‚         â”‚                    â”‚ (5555)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ æ•°æ®æµä¸å‘½åè§„èŒƒ

### ç»Ÿä¸€å‘½åè½¬æ¢æœºåˆ¶

é¡¹ç›®é‡‡ç”¨å‰åç«¯ç»Ÿä¸€çš„ **camelCase** å‘½åè§„èŒƒï¼Œé€šè¿‡ Prisma çš„ `@map` æ³¨è§£å®ç°æ•°æ®åº“å­—æ®µæ˜ å°„ï¼š

#### å‘½åè§„åˆ™å¯¹ç…§è¡¨

| å±‚çº§ | å‘½åè§„èŒƒ | ç¤ºä¾‹ |
|------|----------|------|
| **å‰ç«¯ JavaScript** | camelCase | `studentCount`, `startDate`, `contactPerson` |
| **API JSON æ•°æ®** | camelCase | `"studentCount": 50`, `"startDate": "2025-09-12"` |
| **æ•°æ®åº“å­—æ®µ** | snake_case | `student_count`, `start_date`, `contact_person` |
| **æ•°æ®åº“è¡¨å** | snake_case (å¤æ•°) | `groups`, `theme_packages`, `educational_resources` |

#### Prisma Schema æ˜ å°„ç¤ºä¾‹

```prisma
model Group {
  id            Int      @id @default(autoincrement())
  name          String
  type          String
  studentCount  Int      @map("student_count")
  teacherCount  Int      @map("teacher_count")
  startDate     DateTime @map("start_date")
  endDate       DateTime @map("end_date")
  contactPerson String?  @map("contact_person")
  contactPhone  String?  @map("contact_phone")
  themePackageId String? @map("theme_package_id")

  @@map("groups")
}
```

#### æ•°æ®è½¬æ¢ç¤ºä¾‹

```javascript
// å‰ç«¯å‘é€çš„æ•°æ® (camelCase)
const requestData = {
  name: "æ·±åœ³å®éªŒå­¦æ ¡å°å­¦éƒ¨",
  studentCount: 44,
  teacherCount: 4,
  startDate: "2025-09-12",
  contactPerson: "å¼ è€å¸ˆ"
};

// Prisma è‡ªåŠ¨è½¬æ¢ä¸ºæ•°æ®åº“æ ¼å¼ (snake_case)
// INSERT INTO groups (name, student_count, teacher_count, start_date, contact_person)
// VALUES ('æ·±åœ³å®éªŒå­¦æ ¡å°å­¦éƒ¨', 44, 4, '2025-09-12', 'å¼ è€å¸ˆ');

// æ•°æ®åº“è¿”å›å Prisma è‡ªåŠ¨è½¬æ¢å› camelCase
const responseData = {
  id: 1,
  name: "æ·±åœ³å®éªŒå­¦æ ¡å°å­¦éƒ¨",
  studentCount: 44,
  teacherCount: 4,
  startDate: "2025-09-12T00:00:00.000Z",
  contactPerson: "å¼ è€å¸ˆ"
};
```

## ğŸŒ ç½‘ç»œé€šä¿¡æ¶æ„

### æœåŠ¡ç«¯å£é…ç½®

```yaml
å¼€å‘ç¯å¢ƒ:
  å‰ç«¯æœåŠ¡: http://localhost:5173 (Vite)
  åç«¯æœåŠ¡: http://localhost:3002 (Express)
  æ•°æ®åº“ç®¡ç†: http://localhost:5555 (Prisma Studio)

ç”Ÿäº§ç¯å¢ƒ:
  å‰ç«¯æœåŠ¡: https://education-connect.example.com
  åç«¯æœåŠ¡: https://api.education-connect.example.com
  æ•°æ®åº“: æœ¬åœ° SQLite æ–‡ä»¶
```

### HTTP è®¤è¯æœºåˆ¶

#### Basic Authentication å®ç°

```javascript
// å‰ç«¯é…ç½® (src/services/api.js)
import axios from 'axios';

const api = axios.create({
  baseURL: 'http://localhost:3002',
  timeout: 10000,
  auth: {
    username: 'admin',
    password: 'admin123'
  },
  headers: {
    'Content-Type': 'application/json',
    'Accept': 'application/json'
  }
});

// åç«¯éªŒè¯ä¸­é—´ä»¶ (server-db.js)
const authenticateToken = (req, res, next) => {
  const authHeader = req.headers.authorization;

  if (!authHeader || !authHeader.startsWith('Basic ')) {
    return res.status(401).json({
      error: 'éœ€è¦è®¤è¯',
      code: 'UNAUTHORIZED'
    });
  }

  const base64Credentials = authHeader.substring(6);
  const credentials = Buffer.from(base64Credentials, 'base64').toString('ascii');
  const [username, password] = credentials.split(':');

  if (username === 'admin' && password === 'admin123') {
    req.user = { username, role: 'admin' };
    next();
  } else {
    res.status(401).json({
      error: 'è®¤è¯å¤±è´¥',
      code: 'INVALID_CREDENTIALS'
    });
  }
};
```

## ğŸ“Š å®Œæ•´ API æ¥å£æ–‡æ¡£

### 1. å›¢ç»„ç®¡ç† API

#### GET /api/groups
```javascript
// è¯·æ±‚
GET /api/groups HTTP/1.1
Authorization: Basic YWRtaW46YWRtaW4xMjM=

// å“åº”
HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "name": "æ·±åœ³å®éªŒå­¦æ ¡å°å­¦éƒ¨",
    "type": "primary",
    "studentCount": 44,
    "teacherCount": 4,
    "startDate": "2025-09-12T00:00:00.000Z",
    "endDate": "2025-09-16T00:00:00.000Z",
    "duration": 5,
    "color": "#1890ff",
    "status": "planning",
    "contactPerson": "å¼ è€å¸ˆ",
    "contactPhone": "13800138000",
    "emergencyContact": "æè€å¸ˆ",
    "emergencyPhone": "13900139000",
    "notes": "",
    "themePackageId": "theme_001",
    "createdAt": "2025-09-20T10:30:00.000Z",
    "updatedAt": "2025-09-21T11:45:00.000Z",
    "createdBy": 1,
    "themePackage": {
      "id": "theme_001",
      "name": "ç§‘æŠ€æ¢ç´¢ä¹‹æ—…",
      "description": "ä¸“æ³¨ç§‘æŠ€åˆ›æ–°çš„å­¦ä¹ ä½“éªŒ",
      "resources": [
        {
          "id": 1,
          "resourceId": "resource_001",
          "sortOrder": 1,
          "resource": {
            "id": "resource_001",
            "name": "é¦™æ¸¯ç§‘å­¦é¦†",
            "type": "museum",
            "category": "science",
            "duration": 3.0,
            "highlights": ["äº’åŠ¨ç‰©ç†å®éªŒ", "ç§‘å­¦åŸç†å±•ç¤º"]
          }
        }
      ]
    },
    "members": [
      {
        "id": 1,
        "name": "å¼ å°æ˜",
        "role": "student",
        "school": "æ·±åœ³å®éªŒå­¦æ ¡",
        "grade": "äº”å¹´çº§"
      },
      {
        "id": 2,
        "name": "æè€å¸ˆ",
        "role": "teacher",
        "school": "æ·±åœ³å®éªŒå­¦æ ¡",
        "subject": "æ•°å­¦"
      }
    ],
    "activities": [],
    "schedules": []
  }
]
```

#### POST /api/groups
```javascript
// è¯·æ±‚
POST /api/groups HTTP/1.1
Authorization: Basic YWRtaW46YWRtaW4xMjM=
Content-Type: application/json

{
  "name": "å¹¿å·ä¸­å­¦",
  "type": "secondary",
  "studentCount": 38,
  "teacherCount": 3,
  "startDate": "2025-09-12",
  "endDate": "2025-09-16",
  "color": "#52c41a",
  "contactPerson": "æè€å¸ˆ",
  "contactPhone": "13900139000",
  "themePackageId": "theme_002"
}

// å“åº”
HTTP/1.1 201 Created
Content-Type: application/json

{
  "id": 2,
  "name": "å¹¿å·ä¸­å­¦",
  "type": "secondary",
  "studentCount": 38,
  "teacherCount": 3,
  "startDate": "2025-09-12T00:00:00.000Z",
  "endDate": "2025-09-16T00:00:00.000Z",
  "duration": 5,
  "color": "#52c41a",
  "status": "pending",
  "contactPerson": "æè€å¸ˆ",
  "contactPhone": "13900139000",
  "themePackageId": "theme_002",
  "createdAt": "2025-09-21T12:00:00.000Z",
  "updatedAt": "2025-09-21T12:00:00.000Z",
  "createdBy": 1
}
```

#### PUT /api/groups/:id
```javascript
// è¯·æ±‚
PUT /api/groups/1 HTTP/1.1
Authorization: Basic YWRtaW46YWRtaW4xMjM=
Content-Type: application/json

{
  "name": "æ·±åœ³å®éªŒå­¦æ ¡å°å­¦éƒ¨ï¼ˆæ›´æ–°ï¼‰",
  "studentCount": 50,
  "teacherCount": 5,
  "contactPerson": "ç‹è€å¸ˆ",
  "notes": "éœ€è¦ç‰¹æ®Šå®‰æ’"
}

// åç«¯å¤„ç†é€»è¾‘
app.put('/api/groups/:id', authenticateToken, async (req, res) => {
  try {
    const { id } = req.params;
    const updateData = req.body;

    // æ¸…ç†ä¸åº”æ›´æ–°çš„å­—æ®µ
    delete updateData.id;
    delete updateData.createdAt;
    delete updateData.createdBy;
    delete updateData.members;
    delete updateData.activities;
    delete updateData.themePackage;

    console.log('ğŸ”„ Updating group with ID:', id);
    console.log('ğŸ“¤ Update data:', JSON.stringify(updateData, null, 2));

    const group = await prisma.group.update({
      where: { id: parseInt(id) },
      data: updateData,
      include: {
        themePackage: {
          include: {
            resources: {
              include: {
                resource: true
              }
            }
          }
        },
        members: {
          orderBy: [
            { role: 'desc' },
            { name: 'asc' }
          ]
        }
      }
    });

    console.log('âœ… Group updated successfully:', {
      id: group.id,
      name: group.name,
      updatedAt: group.updatedAt
    });

    res.json(group);

  } catch (error) {
    console.error('âŒ Update group error:', error);
    res.status(500).json({
      error: 'æ›´æ–°å›¢ç»„å¤±è´¥',
      details: process.env.NODE_ENV === 'development' ? error.message : undefined
    });
  }
});
```

### 2. æ•™è‚²èµ„æºç®¡ç† API

#### GET /api/educational-resources
```javascript
// å“åº”
[
  {
    "id": "resource_001",
    "name": "é¦™æ¸¯ç§‘å­¦é¦†",
    "type": "museum",
    "category": "science",
    "description": "å±•ç¤ºå„ç§ç§‘å­¦åŸç†çš„äº’åŠ¨åšç‰©é¦†",
    "location": "å°–æ²™å’€ä¸œéƒ¨ç§‘å­¦é¦†é“2å·",
    "duration": 3.0,
    "ageGroups": ["primary", "secondary"],
    "highlights": [
      "äº’åŠ¨ç‰©ç†å®éªŒ",
      "ç§‘å­¦åŸç†å±•ç¤º",
      "å›¢é˜Ÿæ¢ç´¢æ´»åŠ¨"
    ],
    "imageUrl": null,
    "icon": "ğŸ”¬",
    "status": "active",
    "isUnique": true,
    "createdAt": "2025-09-20T17:32:19.622Z",
    "updatedAt": "2025-09-21T05:44:12.820Z"
  }
]
```

#### POST /api/educational-resources
```javascript
// è¯·æ±‚
{
  "name": "é¦™æ¸¯å¤ªç©ºé¦†",
  "type": "museum",
  "category": "science",
  "description": "å¤©æ–‡ç§‘å­¦å±•ç¤ºé¦†",
  "location": "å°–æ²™å’€æ¢³å£«å·´åˆ©é“10å·",
  "duration": 2.5,
  "ageGroups": ["primary", "secondary"],
  "highlights": ["å¤©è±¡å…", "å¤ªç©ºç§‘å­¦å±•è§ˆ", "äº’åŠ¨å±•ç¤º"],
  "icon": "ğŸš€"
}
```

### 3. ä¸»é¢˜åŒ…ç®¡ç† API

#### GET /api/theme-packages
```javascript
// å“åº”
[
  {
    "id": "theme_001",
    "name": "ç§‘æŠ€æ¢ç´¢ä¹‹æ—…",
    "description": "ä¸“æ³¨ç§‘æŠ€åˆ›æ–°çš„å­¦ä¹ ä½“éªŒ",
    "tags": ["ç§‘æŠ€", "åˆ›æ–°", "STEM"],
    "status": "active",
    "createdAt": "2025-09-20T17:32:19.743Z",
    "updatedAt": "2025-09-21T05:44:12.833Z",
    "resources": [
      {
        "id": 1,
        "themePackageId": "theme_001",
        "resourceId": "resource_001",
        "sortOrder": 1,
        "resource": {
          "id": "resource_001",
          "name": "é¦™æ¸¯ç§‘å­¦é¦†",
          "type": "museum",
          "category": "science",
          "duration": 3.0,
          "highlights": ["äº’åŠ¨ç‰©ç†å®éªŒ", "ç§‘å­¦åŸç†å±•ç¤º"]
        }
      },
      {
        "id": 2,
        "themePackageId": "theme_001",
        "resourceId": "resource_002",
        "sortOrder": 2,
        "resource": {
          "id": "resource_002",
          "name": "é¦™æ¸¯å¤ªç©ºé¦†",
          "type": "museum",
          "category": "science",
          "duration": 2.5,
          "highlights": ["å¤©è±¡å…", "å¤ªç©ºç§‘å­¦å±•è§ˆ"]
        }
      }
    ]
  }
]
```

#### POST /api/theme-packages
```javascript
// è¯·æ±‚
{
  "name": "å†å²æ–‡åŒ–ä¹‹æ—…",
  "description": "æ·±å…¥äº†è§£é¦™æ¸¯å†å²æ–‡åŒ–",
  "tags": ["å†å²", "æ–‡åŒ–", "ä¼ ç»Ÿ"],
  "resources": [
    {
      "resourceId": "resource_003",
      "sortOrder": 1
    },
    {
      "resourceId": "resource_004",
      "sortOrder": 2
    }
  ]
}
```

### 4. å›¢å‘˜ç®¡ç† API

#### GET /api/groups/:id/members
```javascript
// å“åº”
[
  {
    "id": 1,
    "groupId": 1,
    "name": "å¼ å°æ˜",
    "role": "student",
    "school": "æ·±åœ³å®éªŒå­¦æ ¡",
    "grade": "äº”å¹´çº§",
    "createdAt": "2025-09-21T10:00:00.000Z"
  },
  {
    "id": 2,
    "groupId": 1,
    "name": "æè€å¸ˆ",
    "role": "teacher",
    "school": "æ·±åœ³å®éªŒå­¦æ ¡",
    "subject": "æ•°å­¦",
    "createdAt": "2025-09-21T10:00:00.000Z"
  }
]
```

#### POST /api/groups/:id/members
```javascript
// è¯·æ±‚
{
  "members": [
    {
      "name": "ç‹å°çº¢",
      "role": "student",
      "school": "æ·±åœ³å®éªŒå­¦æ ¡",
      "grade": "äº”å¹´çº§"
    },
    {
      "name": "é™ˆè€å¸ˆ",
      "role": "teacher",
      "school": "æ·±åœ³å®éªŒå­¦æ ¡",
      "subject": "è¯­æ–‡"
    }
  ]
}
```

## ğŸ”„ è‡ªåŠ¨ä¿å­˜æœºåˆ¶è¯¦è§£

### å‰ç«¯è‡ªåŠ¨ä¿å­˜å®ç°

#### é˜²æŠ–ï¼ˆDebounceï¼‰æœºåˆ¶
```javascript
// GroupInfoSimple.jsx
import { debounce } from 'lodash';

const GroupInfoSimple = ({ groupData, onUpdate, isNew }) => {
  // è‡ªåŠ¨ä¿å­˜å‡½æ•°ï¼Œ800ms é˜²æŠ–
  const handleAutoSave = useCallback(
    debounce(async () => {
      if (!isNew && groupData.id) {
        try {
          console.log('ğŸ’¾ å¼€å§‹è‡ªåŠ¨ä¿å­˜...', {
            groupId: groupData.id,
            timestamp: new Date().toISOString()
          });

          const response = await api.put(`/groups/${groupData.id}`, groupData);

          console.log('âœ… è‡ªåŠ¨ä¿å­˜æˆåŠŸ:', response.data);

          // å¯é€‰ï¼šæ˜¾ç¤ºæˆåŠŸæç¤º
          // message.success('æ•°æ®å·²è‡ªåŠ¨ä¿å­˜', 1);

        } catch (error) {
          console.error('âŒ è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
          message.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä¿å­˜');
        }
      }
    }, 800), // 800æ¯«ç§’é˜²æŠ–å»¶è¿Ÿ
    [groupData, isNew]
  );

  // æ•°æ®æ›´æ–°å¤„ç†
  const handleFieldChange = (field, value) => {
    // 1. ç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€
    onUpdate(field, value);

    // 2. è§¦å‘è‡ªåŠ¨ä¿å­˜ï¼ˆé˜²æŠ–ï¼‰
    handleAutoSave();
  };

  return (
    <div className="group-info-form">
      {/* å›¢ç»„åç§°è¾“å…¥æ¡† */}
      <input
        type="text"
        value={groupData.name || ''}
        onChange={(e) => handleFieldChange('name', e.target.value)}
        placeholder="è¾“å…¥å›¢ç»„åç§°"
      />

      {/* å­¦ç”Ÿäººæ•°è¾“å…¥æ¡† */}
      <input
        type="number"
        value={groupData.studentCount || 0}
        onChange={(e) => handleFieldChange('studentCount', parseInt(e.target.value) || 0)}
        placeholder="å­¦ç”Ÿäººæ•°"
      />

      {/* å…¶ä»–è¡¨å•å­—æ®µ... */}
    </div>
  );
};
```

#### è‡ªåŠ¨ä¿å­˜çŠ¶æ€ç®¡ç†
```javascript
// GroupEditV2.jsx
const GroupEditV2 = () => {
  const [groupData, setGroupData] = useState({});
  const [saveStatus, setSaveStatus] = useState('saved'); // saved, saving, error
  const [lastSaved, setLastSaved] = useState(null);

  // ç»Ÿä¸€çš„æ•°æ®æ›´æ–°å‡½æ•°
  const handleUpdate = useCallback((field, value) => {
    setGroupData(prev => {
      const updated = { ...prev, [field]: value };

      // è‡ªåŠ¨è®¡ç®—ç›¸å…³å­—æ®µ
      if (field === 'startDate' || field === 'endDate') {
        if (updated.startDate && updated.endDate) {
          const start = dayjs(updated.startDate);
          const end = dayjs(updated.endDate);
          updated.duration = end.diff(start, 'day') + 1;
        }
      }

      // æ ‡è®°ä¸ºéœ€è¦ä¿å­˜
      setSaveStatus('pending');

      return updated;
    });
  }, []);

  // å¢å¼ºçš„è‡ªåŠ¨ä¿å­˜å‡½æ•°
  const handleAutoSave = useCallback(
    debounce(async () => {
      if (!isNew && groupData.id && saveStatus === 'pending') {
        setSaveStatus('saving');

        try {
          const response = await api.put(`/groups/${groupData.id}`, groupData);

          setSaveStatus('saved');
          setLastSaved(new Date());

          console.log('âœ… è‡ªåŠ¨ä¿å­˜å®Œæˆ');

        } catch (error) {
          setSaveStatus('error');
          console.error('âŒ è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
        }
      }
    }, 800),
    [groupData, isNew, saveStatus]
  );

  // ä¿å­˜çŠ¶æ€æŒ‡ç¤ºå™¨
  const SaveStatusIndicator = () => (
    <div className="save-status">
      {saveStatus === 'saving' && (
        <span className="saving">
          <LoadingOutlined /> æ­£åœ¨ä¿å­˜...
        </span>
      )}
      {saveStatus === 'saved' && lastSaved && (
        <span className="saved">
          <CheckOutlined /> å·²ä¿å­˜ ({dayjs(lastSaved).format('HH:mm:ss')})
        </span>
      )}
      {saveStatus === 'error' && (
        <span className="error">
          <ExclamationOutlined /> ä¿å­˜å¤±è´¥
        </span>
      )}
    </div>
  );

  return (
    <div className="group-edit-container">
      <div className="group-edit-header">
        <h2>ç¼–è¾‘å›¢ç»„</h2>
        <SaveStatusIndicator />
      </div>

      <GroupInfoSimple
        groupData={groupData}
        onUpdate={handleUpdate}
        handleAutoSave={handleAutoSave}
        isNew={isNew}
      />
    </div>
  );
};
```

### åç«¯æ•°æ®æŒä¹…åŒ–æœºåˆ¶

#### Prisma äº‹åŠ¡å¤„ç†
```javascript
// server-db.js
app.put('/api/groups/:id', authenticateToken, async (req, res) => {
  try {
    const { id } = req.params;
    const updateData = req.body;

    // æ•°æ®æ¸…ç†å’ŒéªŒè¯
    delete updateData.id;
    delete updateData.createdAt;
    delete updateData.createdBy;
    delete updateData.members;
    delete updateData.activities;
    delete updateData.themePackage;

    console.log('ğŸ”„ Updating group with ID:', id);
    console.log('ğŸ“¤ Update data:', JSON.stringify(updateData, null, 2));

    // ä½¿ç”¨ Prisma äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
    const result = await prisma.$transaction(async (prisma) => {
      // 1. æ›´æ–°å›¢ç»„åŸºæœ¬ä¿¡æ¯
      const group = await prisma.group.update({
        where: { id: parseInt(id) },
        data: {
          ...updateData,
          updatedAt: new Date()
        },
        include: {
          themePackage: {
            include: {
              resources: {
                include: {
                  resource: true
                }
              }
            }
          },
          members: {
            orderBy: [
              { role: 'desc' },
              { name: 'asc' }
            ]
          }
        }
      });

      // 2. å¦‚æœæ—¥æœŸå‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°ç”ŸæˆåŸºç¡€æ´»åŠ¨
      if (updateData.startDate || updateData.endDate) {
        // åˆ é™¤æ—§çš„åŸºç¡€æ´»åŠ¨
        await prisma.activity.deleteMany({
          where: {
            groupId: parseInt(id),
            isBaseActivity: true
          }
        });

        // ç”Ÿæˆæ–°çš„åŸºç¡€æ´»åŠ¨
        if (group.startDate && group.endDate) {
          const activities = generateBaseActivities(group);
          await prisma.activity.createMany({
            data: activities
          });
        }
      }

      return group;
    });

    console.log('âœ… Group updated successfully:', {
      id: result.id,
      name: result.name,
      updatedAt: result.updatedAt
    });

    res.json(result);

  } catch (error) {
    console.error('âŒ Update group error:', error);

    // è¯¦ç»†é”™è¯¯ä¿¡æ¯
    if (error.code === 'P2025') {
      res.status(404).json({
        error: 'å›¢ç»„ä¸å­˜åœ¨',
        code: 'GROUP_NOT_FOUND'
      });
    } else if (error.code === 'P2002') {
      res.status(400).json({
        error: 'æ•°æ®é‡å¤',
        code: 'DUPLICATE_DATA'
      });
    } else {
      res.status(500).json({
        error: 'æ›´æ–°å›¢ç»„å¤±è´¥',
        code: 'INTERNAL_ERROR',
        details: process.env.NODE_ENV === 'development' ? error.message : undefined
      });
    }
  }
});
```

## ğŸ­ å‰ç«¯ç»„ä»¶äº¤äº’æ¶æ„

### ç»„ä»¶å±‚æ¬¡ç»“æ„

```
App.jsx
â”œâ”€â”€ Router
â”‚   â”œâ”€â”€ GroupManagement.jsx          # å›¢ç»„åˆ—è¡¨é¡µé¢
â”‚   â”œâ”€â”€ GroupEditV2/                 # å›¢ç»„ç¼–è¾‘æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ GroupEditV2.jsx          # ä¸»ç¼–è¾‘å®¹å™¨
â”‚   â”‚   â”œâ”€â”€ GroupInfoSimple.jsx      # åŸºæœ¬ä¿¡æ¯ç¼–è¾‘
â”‚   â”‚   â””â”€â”€ MemberManagement.jsx     # å›¢å‘˜ç®¡ç†
â”‚   â”œâ”€â”€ DragDropTable.jsx            # æ—¥å†è§†å›¾ï¼ˆé¦–é¡µï¼‰
â”‚   â”œâ”€â”€ ItineraryDesigner.jsx        # è¡Œç¨‹è®¾è®¡å™¨
â”‚   â”œâ”€â”€ LocationManagement.jsx       # æ•™è‚²èµ„æºç®¡ç†
â”‚   â””â”€â”€ Statistics.jsx               # ç»Ÿè®¡æŠ¥è¡¨
â””â”€â”€ services/
    â””â”€â”€ api.js                       # API æœåŠ¡å±‚
```

### çŠ¶æ€ç®¡ç†æµç¨‹

#### å›¢ç»„ç¼–è¾‘ç»„ä»¶çš„çŠ¶æ€æµ
```javascript
// GroupEditV2.jsx (çˆ¶ç»„ä»¶)
const GroupEditV2 = () => {
  const [groupData, setGroupData] = useState({
    name: '',
    type: 'primary',
    studentCount: 0,
    teacherCount: 0,
    startDate: '',
    endDate: '',
    duration: 0,
    color: '#1890ff',
    contactPerson: '',
    contactPhone: '',
    themePackageId: '',
    notes: ''
  });

  // ç»Ÿä¸€çš„çŠ¶æ€æ›´æ–°å‡½æ•°
  const handleUpdate = useCallback((field, value) => {
    setGroupData(prev => {
      const updated = { ...prev, [field]: value };

      // è‡ªåŠ¨è®¡ç®—é€»è¾‘
      if (field === 'startDate' || field === 'endDate') {
        if (updated.startDate && updated.endDate) {
          const start = dayjs(updated.startDate);
          const end = dayjs(updated.endDate);
          updated.duration = end.diff(start, 'day') + 1;
        }
      }

      return updated;
    });
  }, []);

  // æ•°æ®åŠ è½½
  useEffect(() => {
    if (groupId && !isNew) {
      loadGroupData(groupId);
    }
  }, [groupId, isNew]);

  const loadGroupData = async (id) => {
    try {
      const response = await api.get(`/groups/${id}`);
      setGroupData(response.data);
    } catch (error) {
      console.error('åŠ è½½å›¢ç»„æ•°æ®å¤±è´¥:', error);
      message.error('åŠ è½½å›¢ç»„æ•°æ®å¤±è´¥');
    }
  };

  return (
    <div className="group-edit-container">
      <GroupInfoSimple
        groupData={groupData}
        onUpdate={handleUpdate}
        handleAutoSave={handleAutoSave}
        isNew={isNew}
      />

      {!isNew && (
        <MemberManagement
          groupId={groupData.id}
          members={groupData.members}
          onMembersUpdate={(members) => {
            setGroupData(prev => ({ ...prev, members }));
          }}
        />
      )}
    </div>
  );
};
```

#### å­ç»„ä»¶çš„å±æ€§ä¼ é€’
```javascript
// GroupInfoSimple.jsx (å­ç»„ä»¶)
const GroupInfoSimple = ({
  groupData,
  onUpdate,
  handleAutoSave,
  isNew
}) => {
  const [themePackages, setThemePackages] = useState([]);

  // è·å–ä¸»é¢˜åŒ…æ•°æ®
  useEffect(() => {
    const fetchThemePackages = async () => {
      try {
        const response = await api.get('/theme-packages');
        if (response.data) {
          setThemePackages(response.data);
        }
      } catch (error) {
        console.error('è·å–ä¸»é¢˜åŒ…å¤±è´¥:', error);
        // é™çº§åˆ°æ¨¡æ‹Ÿæ•°æ®
        setThemePackages([
          { id: 'theme_001', name: 'ç§‘æŠ€æ¢ç´¢ä¹‹æ—…', resourceCount: 3 },
          { id: 'theme_002', name: 'æ–‡åŒ–æ·±åº¦æ¸¸', resourceCount: 2 }
        ]);
      }
    };
    fetchThemePackages();
  }, []);

  // å­—æ®µå˜æ›´å¤„ç†
  const handleFieldChange = (field, value) => {
    onUpdate(field, value);
    handleAutoSave();
  };

  return (
    <div className="unified-info-view">
      <div className="info-card">
        <div className="card-body">
          {/* ç¬¬ä¸€è¡Œï¼šåç§°ã€ç±»å‹ã€é¢œè‰² */}
          <div className="info-row">
            <div className="info-item flex-2">
              <label>å›¢ç»„åç§°</label>
              <input
                type="text"
                value={groupData.name || ''}
                onChange={(e) => handleFieldChange('name', e.target.value)}
                placeholder="è¾“å…¥å›¢ç»„åç§°"
              />
            </div>

            <div className="info-item">
              <label>ç±»å‹</label>
              <select
                value={groupData.type || 'primary'}
                onChange={(e) => handleFieldChange('type', e.target.value)}
              >
                <option value="primary">å°å­¦</option>
                <option value="secondary">ä¸­å­¦</option>
              </select>
            </div>

            <div className="info-item color-picker">
              <label>é¢œè‰²</label>
              <input
                type="color"
                value={groupData.color || '#1890ff'}
                onChange={(e) => handleFieldChange('color', e.target.value)}
              />
            </div>
          </div>

          {/* ä¸»é¢˜åŒ…é€‰æ‹© */}
          <div className="info-row">
            <div className="info-item flex-2">
              <label>æ•™è‚²ä¸»é¢˜åŒ…</label>
              <select
                value={groupData.themePackageId || ''}
                onChange={(e) => handleFieldChange('themePackageId', e.target.value)}
              >
                <option value="">è¯·é€‰æ‹©ä¸»é¢˜åŒ…</option>
                {themePackages.map(pkg => (
                  <option key={pkg.id} value={pkg.id}>
                    {pkg.name}
                  </option>
                ))}
              </select>
            </div>
          </div>
        </div>
      </div>

      {/* å›¢å‘˜ä¿¡æ¯å¡ç‰‡ */}
      {!isNew && (
        <div className="info-card">
          <div className="card-header">
            <span className="card-title">å›¢å‘˜ä¿¡æ¯</span>
            <div className="member-stats">
              <button
                className="btn-add-members"
                onClick={() => window.openMemberModal && window.openMemberModal(groupData.id)}
              >
                + ç®¡ç†å›¢å‘˜
              </button>
              <span>å­¦ç”Ÿ {groupData.members?.filter(m => m.role === 'student').length || 0}</span>
              <span>è€å¸ˆ {groupData.members?.filter(m => m.role === 'teacher').length || 0}</span>
              <span>æ€»è®¡ {groupData.members?.length || 0}</span>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};
```

## ğŸ” é”™è¯¯å¤„ç†ä¸ç›‘æ§

### å‰ç«¯é”™è¯¯å¤„ç†æœºåˆ¶

#### å…¨å±€é”™è¯¯æ‹¦æˆªå™¨
```javascript
// services/api.js
import axios from 'axios';
import { message } from 'antd';

const api = axios.create({
  baseURL: 'http://localhost:3002',
  timeout: 10000,
  auth: {
    username: 'admin',
    password: 'admin123'
  }
});

// è¯·æ±‚æ‹¦æˆªå™¨
api.interceptors.request.use(
  (config) => {
    console.log(`ğŸš€ å‘èµ·è¯·æ±‚: ${config.method?.toUpperCase()} ${config.url}`);

    // æ·»åŠ è¯·æ±‚IDç”¨äºè¿½è¸ª
    config.requestId = Date.now() + Math.random().toString(36);

    return config;
  },
  (error) => {
    console.error('âŒ è¯·æ±‚é…ç½®é”™è¯¯:', error);
    return Promise.reject(error);
  }
);

// å“åº”æ‹¦æˆªå™¨
api.interceptors.response.use(
  (response) => {
    console.log(`âœ… è¯·æ±‚æˆåŠŸ: ${response.config.method?.toUpperCase()} ${response.config.url}`);
    return response;
  },
  (error) => {
    console.error('âŒ è¯·æ±‚å¤±è´¥:', error);

    // é”™è¯¯åˆ†ç±»å¤„ç†
    if (error.code === 'ECONNREFUSED') {
      message.error('åç«¯æœåŠ¡æœªå¯åŠ¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€');
    } else if (error.code === 'ECONNABORTED') {
      message.error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    } else if (error.response) {
      // æœåŠ¡å™¨å“åº”é”™è¯¯
      const { status, data } = error.response;

      switch (status) {
        case 400:
          message.error(data.error || 'è¯·æ±‚å‚æ•°é”™è¯¯');
          break;
        case 401:
          message.error('è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå¯†ç ');
          break;
        case 403:
          message.error('æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œæ­¤æ“ä½œ');
          break;
        case 404:
          message.error('è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨');
          break;
        case 500:
          message.error('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
          break;
        default:
          message.error(`è¯·æ±‚å¤±è´¥ (${status}): ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
      }
    } else {
      message.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    }

    return Promise.reject(error);
  }
);

export default api;
```

#### React é”™è¯¯è¾¹ç•Œ
```javascript
// components/ErrorBoundary.jsx
import React from 'react';
import { Result, Button } from 'antd';

class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      hasError: false,
      error: null,
      errorInfo: null
    };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true };
  }

  componentDidCatch(error, errorInfo) {
    console.error('React Error Boundary æ•è·é”™è¯¯:', error, errorInfo);

    this.setState({
      error,
      errorInfo
    });

    // å‘é€é”™è¯¯æŠ¥å‘Šåˆ°ç›‘æ§æœåŠ¡
    if (process.env.NODE_ENV === 'production') {
      this.reportError(error, errorInfo);
    }
  }

  reportError = (error, errorInfo) => {
    // å‘é€åˆ°é”™è¯¯ç›‘æ§æœåŠ¡
    fetch('/api/errors', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        error: error.toString(),
        stack: error.stack,
        componentStack: errorInfo.componentStack,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        url: window.location.href
      })
    }).catch(err => {
      console.error('å‘é€é”™è¯¯æŠ¥å‘Šå¤±è´¥:', err);
    });
  };

  handleReload = () => {
    window.location.reload();
  };

  render() {
    if (this.state.hasError) {
      return (
        <Result
          status="error"
          title="é¡µé¢å‡ºé”™äº†"
          subTitle="æŠ±æ­‰ï¼Œé¡µé¢å‘ç”Ÿäº†é”™è¯¯ã€‚æ‚¨å¯ä»¥å°è¯•åˆ·æ–°é¡µé¢æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚"
          extra={[
            <Button type="primary" onClick={this.handleReload} key="reload">
              åˆ·æ–°é¡µé¢
            </Button>,
            <Button key="home" onClick={() => window.location.href = '/'}>
              è¿”å›é¦–é¡µ
            </Button>
          ]}
        />
      );
    }

    return this.props.children;
  }
}

export default ErrorBoundary;
```

### åç«¯é”™è¯¯å¤„ç†æœºåˆ¶

#### ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸­é—´ä»¶
```javascript
// server-db.js
const errorHandler = (err, req, res, next) => {
  console.error('Server Error:', {
    message: err.message,
    stack: err.stack,
    url: req.url,
    method: req.method,
    timestamp: new Date().toISOString()
  });

  // Prisma ç‰¹å®šé”™è¯¯å¤„ç†
  if (err.code && err.code.startsWith('P')) {
    switch (err.code) {
      case 'P2002':
        return res.status(400).json({
          error: 'æ•°æ®é‡å¤ï¼Œè¯·æ£€æŸ¥è¾“å…¥å†…å®¹',
          code: 'DUPLICATE_DATA',
          field: err.meta?.target
        });

      case 'P2025':
        return res.status(404).json({
          error: 'è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨',
          code: 'RESOURCE_NOT_FOUND'
        });

      case 'P2003':
        return res.status(400).json({
          error: 'å¤–é”®çº¦æŸå¤±è´¥',
          code: 'FOREIGN_KEY_CONSTRAINT'
        });

      default:
        return res.status(500).json({
          error: 'æ•°æ®åº“æ“ä½œå¤±è´¥',
          code: 'DATABASE_ERROR',
          details: process.env.NODE_ENV === 'development' ? err.message : undefined
        });
    }
  }

  // éªŒè¯é”™è¯¯
  if (err.name === 'ValidationError') {
    return res.status(400).json({
      error: 'æ•°æ®éªŒè¯å¤±è´¥',
      code: 'VALIDATION_ERROR',
      details: err.details
    });
  }

  // é»˜è®¤é”™è¯¯
  res.status(500).json({
    error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
    code: 'INTERNAL_ERROR',
    details: process.env.NODE_ENV === 'development' ? err.message : undefined
  });
};

// 404 å¤„ç†
const notFoundHandler = (req, res) => {
  res.status(404).json({
    error: 'è¯·æ±‚çš„ API ç«¯ç‚¹ä¸å­˜åœ¨',
    code: 'ENDPOINT_NOT_FOUND',
    path: req.path,
    method: req.method
  });
};

// åº”ç”¨é”™è¯¯å¤„ç†ä¸­é—´ä»¶
app.use(errorHandler);
app.use('*', notFoundHandler);
```

#### æ•°æ®éªŒè¯ä¸­é—´ä»¶
```javascript
const { body, validationResult } = require('express-validator');

// å›¢ç»„æ•°æ®éªŒè¯è§„åˆ™
const validateGroup = [
  body('name')
    .trim()
    .notEmpty()
    .withMessage('å›¢ç»„åç§°ä¸èƒ½ä¸ºç©º')
    .isLength({ min: 1, max: 200 })
    .withMessage('å›¢ç»„åç§°é•¿åº¦å¿…é¡»åœ¨1-200å­—ç¬¦ä¹‹é—´'),

  body('type')
    .isIn(['primary', 'secondary'])
    .withMessage('å›¢ç»„ç±»å‹å¿…é¡»æ˜¯ primary æˆ– secondary'),

  body('studentCount')
    .isInt({ min: 0, max: 1000 })
    .withMessage('å­¦ç”Ÿäººæ•°å¿…é¡»æ˜¯0-1000ä¹‹é—´çš„æ•´æ•°'),

  body('teacherCount')
    .isInt({ min: 0, max: 100 })
    .withMessage('è€å¸ˆäººæ•°å¿…é¡»æ˜¯0-100ä¹‹é—´çš„æ•´æ•°'),

  body('startDate')
    .isISO8601()
    .withMessage('å¼€å§‹æ—¥æœŸæ ¼å¼ä¸æ­£ç¡®'),

  body('endDate')
    .isISO8601()
    .withMessage('ç»“æŸæ—¥æœŸæ ¼å¼ä¸æ­£ç¡®')
    .custom((value, { req }) => {
      if (new Date(value) <= new Date(req.body.startDate)) {
        throw new Error('ç»“æŸæ—¥æœŸå¿…é¡»æ™šäºå¼€å§‹æ—¥æœŸ');
      }
      return true;
    }),

  body('contactPhone')
    .optional()
    .matches(/^1[3-9]\d{9}$/)
    .withMessage('è”ç³»ç”µè¯æ ¼å¼ä¸æ­£ç¡®')
];

// éªŒè¯ç»“æœå¤„ç†ä¸­é—´ä»¶
const handleValidationErrors = (req, res, next) => {
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    return res.status(400).json({
      error: 'æ•°æ®éªŒè¯å¤±è´¥',
      code: 'VALIDATION_ERROR',
      details: errors.array()
    });
  }
  next();
};

// ä½¿ç”¨éªŒè¯ä¸­é—´ä»¶
app.post('/api/groups', validateGroup, handleValidationErrors, async (req, res) => {
  // å¤„ç†åˆ›å»ºå›¢ç»„é€»è¾‘
});

app.put('/api/groups/:id', validateGroup, handleValidationErrors, async (req, res) => {
  // å¤„ç†æ›´æ–°å›¢ç»„é€»è¾‘
});
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### å‰ç«¯æ€§èƒ½ä¼˜åŒ–

#### ç»„ä»¶ä¼˜åŒ–
```javascript
// ä½¿ç”¨ React.memo ä¼˜åŒ–é‡æ¸²æŸ“
const GroupInfoSimple = React.memo(({
  groupData,
  onUpdate,
  handleAutoSave,
  isNew
}) => {
  // ç»„ä»¶å®ç°
}, (prevProps, nextProps) => {
  // è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°ï¼Œé¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
  return (
    prevProps.groupData === nextProps.groupData &&
    prevProps.isNew === nextProps.isNew
  );
});

// ä½¿ç”¨ useCallback ç¼“å­˜å‡½æ•°
const handleAutoSave = useCallback(
  debounce(async () => {
    if (!isNew && groupData.id) {
      await api.put(`/groups/${groupData.id}`, groupData);
    }
  }, 800),
  [groupData, isNew]
);

// ä½¿ç”¨ useMemo ç¼“å­˜è®¡ç®—ç»“æœ
const filteredGroups = useMemo(() => {
  return groups.filter(group =>
    group.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
    group.contactPerson.toLowerCase().includes(searchTerm.toLowerCase())
  );
}, [groups, searchTerm]);

// è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–å¤§åˆ—è¡¨
import { FixedSizeList as List } from 'react-window';

const GroupList = ({ groups }) => {
  const Row = ({ index, style }) => (
    <div style={style}>
      <GroupItem group={groups[index]} />
    </div>
  );

  return (
    <List
      height={600}
      itemCount={groups.length}
      itemSize={80}
      overscanCount={5}
    >
      {Row}
    </List>
  );
};
```

#### ç¼“å­˜ç­–ç•¥
```javascript
// å†…å­˜ç¼“å­˜å®ç°
class CacheManager {
  constructor() {
    this.cache = new Map();
    this.maxSize = 100;
    this.defaultTTL = 5 * 60 * 1000; // 5åˆ†é’Ÿ
  }

  set(key, value, ttl = this.defaultTTL) {
    // æ¸…ç†è¿‡æœŸç¼“å­˜
    this.cleanup();

    // æ£€æŸ¥ç¼“å­˜å¤§å°
    if (this.cache.size >= this.maxSize) {
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }

    this.cache.set(key, {
      value,
      timestamp: Date.now(),
      ttl
    });
  }

  get(key) {
    const item = this.cache.get(key);
    if (!item) return null;

    if (Date.now() - item.timestamp > item.ttl) {
      this.cache.delete(key);
      return null;
    }

    return item.value;
  }

  cleanup() {
    const now = Date.now();
    for (const [key, item] of this.cache.entries()) {
      if (now - item.timestamp > item.ttl) {
        this.cache.delete(key);
      }
    }
  }

  clear() {
    this.cache.clear();
  }
}

const cache = new CacheManager();

// å¸¦ç¼“å­˜çš„APIè°ƒç”¨
const getCachedData = async (endpoint, forceRefresh = false) => {
  const cacheKey = `api_${endpoint}`;

  if (!forceRefresh) {
    const cached = cache.get(cacheKey);
    if (cached) {
      console.log(`ğŸ“¦ ä»ç¼“å­˜è·å–: ${endpoint}`);
      return cached;
    }
  }

  console.log(`ğŸŒ ä»æœåŠ¡å™¨è·å–: ${endpoint}`);
  const response = await api.get(endpoint);

  cache.set(cacheKey, response.data);
  return response.data;
};
```

### åç«¯æ€§èƒ½ä¼˜åŒ–

#### æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
```javascript
// ä¼˜åŒ–æŸ¥è¯¢ï¼šä½¿ç”¨ select å‡å°‘æ•°æ®ä¼ è¾“
const getGroupsOptimized = async (req, res) => {
  try {
    const groups = await prisma.group.findMany({
      select: {
        id: true,
        name: true,
        type: true,
        studentCount: true,
        teacherCount: true,
        startDate: true,
        endDate: true,
        duration: true,
        color: true,
        status: true,
        themePackage: {
          select: {
            id: true,
            name: true
          }
        },
        _count: {
          select: {
            members: true,
            activities: true
          }
        }
      },
      orderBy: {
        createdAt: 'desc'
      }
    });

    res.json(groups);
  } catch (error) {
    next(error);
  }
};

// åˆ†é¡µæŸ¥è¯¢
const getGroupsWithPagination = async (req, res) => {
  try {
    const page = parseInt(req.query.page) || 1;
    const limit = parseInt(req.query.limit) || 10;
    const skip = (page - 1) * limit;

    const [groups, total] = await Promise.all([
      prisma.group.findMany({
        skip,
        take: limit,
        include: {
          themePackage: {
            select: { id: true, name: true }
          },
          _count: {
            select: { members: true }
          }
        },
        orderBy: { createdAt: 'desc' }
      }),
      prisma.group.count()
    ]);

    res.json({
      data: groups,
      pagination: {
        page,
        limit,
        total,
        pages: Math.ceil(total / limit)
      }
    });
  } catch (error) {
    next(error);
  }
};

// è¿æ¥æ± ä¼˜åŒ–
const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.DATABASE_URL
    }
  },
  log: [
    { emit: 'event', level: 'query' },
    { emit: 'event', level: 'error' },
  ]
});

// æŸ¥è¯¢æ€§èƒ½ç›‘æ§
prisma.$on('query', (e) => {
  if (e.duration > 1000) {
    console.warn(`ğŸŒ æ…¢æŸ¥è¯¢è­¦å‘Š: ${e.query} (${e.duration}ms)`);
  }
});
```

#### è¯·æ±‚å»é‡å’Œé˜²æŠ–
```javascript
// è¯·æ±‚å»é‡ä¸­é—´ä»¶
const requestDeduplication = () => {
  const pendingRequests = new Map();

  return (req, res, next) => {
    const key = `${req.method}_${req.path}_${JSON.stringify(req.body)}`;

    if (pendingRequests.has(key)) {
      console.log(`â³ é‡å¤è¯·æ±‚ï¼Œç­‰å¾…ç°æœ‰è¯·æ±‚: ${key}`);

      pendingRequests.get(key).then(
        (result) => res.json(result),
        (error) => next(error)
      );

      return;
    }

    const promise = new Promise((resolve, reject) => {
      res.originalJson = res.json;
      res.json = (data) => {
        resolve(data);
        res.originalJson(data);
      };

      const originalNext = next;
      next = (error) => {
        reject(error);
        originalNext(error);
      };

      process.nextTick(() => {
        next();
      });
    }).finally(() => {
      pendingRequests.delete(key);
    });

    pendingRequests.set(key, promise);
  };
};

// åº”ç”¨å»é‡ä¸­é—´ä»¶åˆ°ç‰¹å®šè·¯ç”±
app.use('/api/groups', requestDeduplication());
```

## ğŸ“Š ç›‘æ§ä¸è°ƒè¯•

### æ€§èƒ½ç›‘æ§
```javascript
// å‰ç«¯æ€§èƒ½ç›‘æ§
class PerformanceMonitor {
  constructor() {
    this.metrics = new Map();
  }

  startTimer(name) {
    this.metrics.set(name, performance.now());
  }

  endTimer(name) {
    const startTime = this.metrics.get(name);
    if (startTime) {
      const duration = performance.now() - startTime;
      console.log(`â±ï¸ ${name}: ${duration.toFixed(2)}ms`);
      this.metrics.delete(name);
      return duration;
    }
  }

  measureApiCall(apiCall) {
    return async (...args) => {
      const startTime = performance.now();
      try {
        const result = await apiCall(...args);
        const duration = performance.now() - startTime;
        console.log(`ğŸŒ API è°ƒç”¨è€—æ—¶: ${duration.toFixed(2)}ms`);
        return result;
      } catch (error) {
        const duration = performance.now() - startTime;
        console.error(`âŒ API è°ƒç”¨å¤±è´¥ (${duration.toFixed(2)}ms):`, error);
        throw error;
      }
    };
  }
}

const monitor = new PerformanceMonitor();

// ä½¿ç”¨ç¤ºä¾‹
const measureApiGet = monitor.measureApiCall(api.get);
const groups = await measureApiGet('/groups');
```

### è°ƒè¯•å·¥å…·
```javascript
// å¼€å‘ç¯å¢ƒè°ƒè¯•å¢å¼º
if (process.env.NODE_ENV === 'development') {
  // å‰ç«¯è°ƒè¯•å·¥å…·
  window.debugTools = {
    api,
    cache,
    monitor,
    clearCache: () => cache.clear(),
    getState: () => ({
      groups: window.groupsState,
      currentUser: window.currentUser
    })
  };

  // åç«¯è°ƒè¯•ä¸­é—´ä»¶
  app.use((req, res, next) => {
    const startTime = Date.now();

    res.on('finish', () => {
      const duration = Date.now() - startTime;
      console.log(`${req.method} ${req.path} - ${res.statusCode} - ${duration}ms`);
    });

    next();
  });
}
```

## ğŸ”§ æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜è¯Šæ–­

#### 1. æ•°æ®æŒä¹…åŒ–é—®é¢˜
```bash
# ç—‡çŠ¶ï¼šå‰ç«¯æ˜¾ç¤ºä¿å­˜æˆåŠŸï¼Œä½†åˆ·æ–°åæ•°æ®ä¸¢å¤±

# æ£€æŸ¥æ­¥éª¤ï¼š
# 1. ç¡®è®¤åç«¯æœåŠ¡çŠ¶æ€
curl -u admin:admin123 http://localhost:3002/api/groups

# 2. æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶
ls -la backend/prisma/dev.db

# 3. ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
sqlite3 backend/prisma/dev.db "SELECT * FROM groups LIMIT 5;"

# 4. æ£€æŸ¥ Prisma æ—¥å¿—
# åœ¨ server-db.js ä¸­å¯ç”¨è¯¦ç»†æ—¥å¿—
```

#### 2. ç«¯å£å†²çªè§£å†³
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :3002
lsof -i :5173
lsof -i :5555

# æ‰¹é‡å…³é—­ç›¸å…³è¿›ç¨‹
pkill -f "node.*server"
pkill -f "npm run dev"
pkill -f "vite"
pkill -f "prisma studio"

# é‡æ–°å¯åŠ¨æœåŠ¡
cd backend && PORT=3002 node server-db.js &
cd frontend && npm run dev &
cd backend && npx prisma studio &
```

#### 3. è‡ªåŠ¨ä¿å­˜å¤±æ•ˆ
```javascript
// è°ƒè¯•è‡ªåŠ¨ä¿å­˜é—®é¢˜
const debugAutoSave = {
  checkLocalState: () => {
    console.log('å½“å‰ç»„ä»¶çŠ¶æ€:', groupData);
  },

  testApiConnection: async () => {
    try {
      const response = await api.get('/groups');
      console.log('âœ… API è¿æ¥æ­£å¸¸');
      return true;
    } catch (error) {
      console.error('âŒ API è¿æ¥å¤±è´¥:', error);
      return false;
    }
  },

  forceSave: async () => {
    try {
      const response = await api.put(`/groups/${groupData.id}`, groupData);
      console.log('âœ… å¼ºåˆ¶ä¿å­˜æˆåŠŸ:', response.data);
    } catch (error) {
      console.error('âŒ å¼ºåˆ¶ä¿å­˜å¤±è´¥:', error);
    }
  }
};

// åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­ä½¿ç”¨
window.debugAutoSave = debugAutoSave;
```

### æ€§èƒ½é—®é¢˜è¯Šæ–­

#### å†…å­˜ä½¿ç”¨ç›‘æ§
```javascript
// åç«¯å†…å­˜ç›‘æ§
const monitorMemory = () => {
  const usage = process.memoryUsage();
  console.log('å†…å­˜ä½¿ç”¨æƒ…å†µ:', {
    rss: `${Math.round(usage.rss / 1024 / 1024)}MB`,
    heapTotal: `${Math.round(usage.heapTotal / 1024 / 1024)}MB`,
    heapUsed: `${Math.round(usage.heapUsed / 1024 / 1024)}MB`,
    external: `${Math.round(usage.external / 1024 / 1024)}MB`
  });
};

// æ¯30ç§’ç›‘æ§ä¸€æ¬¡
setInterval(monitorMemory, 30000);
```

#### æ•°æ®åº“æ€§èƒ½åˆ†æ
```javascript
// Prisma æŸ¥è¯¢æ€§èƒ½ç›‘æ§
prisma.$on('query', (e) => {
  console.log('æŸ¥è¯¢:', e.query);
  console.log('å‚æ•°:', e.params);
  console.log('è€—æ—¶:', e.duration + 'ms');

  if (e.duration > 1000) {
    console.warn('âš ï¸ æ…¢æŸ¥è¯¢è­¦å‘Š:', e.query);
  }
});
```

## ğŸš€ éƒ¨ç½²ä¸æ‰©å±•

### ç”Ÿäº§ç¯å¢ƒé…ç½®

#### Docker å®¹å™¨åŒ–
```dockerfile
# frontend/Dockerfile
FROM node:18-alpine AS build
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]

# backend/Dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
COPY prisma ./prisma/
RUN npm ci --only=production
RUN npx prisma generate
COPY . .
RUN mkdir -p prisma
EXPOSE 3002
CMD ["npm", "start"]
```

#### Docker Compose é…ç½®
```yaml
# docker-compose.yml
version: '3.8'

services:
  frontend:
    build:
      context: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    environment:
      - REACT_APP_API_URL=http://backend:3002

  backend:
    build:
      context: ./backend
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=file:./prisma/production.db
    volumes:
      - ./data/db:/app/prisma
      - ./data/uploads:/app/uploads

  prisma-studio:
    build:
      context: ./backend
    ports:
      - "5555:5555"
    command: npx prisma studio --port 5555 --hostname 0.0.0.0
    depends_on:
      - backend
    volumes:
      - ./data/db:/app/prisma
```

### æ‰©å±•è®¡åˆ’

#### å®æ—¶åä½œåŠŸèƒ½
```javascript
// WebSocket å®ç°è®¡åˆ’
class RealtimeCollaboration {
  constructor() {
    this.ws = null;
    this.reconnectAttempts = 0;
  }

  connect() {
    this.ws = new WebSocket('ws://localhost:3002/ws');

    this.ws.onmessage = (event) => {
      const message = JSON.parse(event.data);
      this.handleMessage(message);
    };
  }

  handleMessage(message) {
    switch (message.type) {
      case 'GROUP_UPDATED':
        this.updateGroupInUI(message.data);
        break;
      case 'USER_EDITING':
        this.showUserCursor(message.data);
        break;
    }
  }

  broadcastEdit(groupId, field, value) {
    this.ws.send(JSON.stringify({
      type: 'FIELD_EDIT',
      groupId,
      field,
      value,
      userId: this.currentUser.id
    }));
  }
}
```

## ğŸ“‹ æ€»ç»“

Education Connect é¡¹ç›®é‡‡ç”¨ç°ä»£åŒ–çš„å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œé€šè¿‡ä»¥ä¸‹æŠ€æœ¯ç‰¹æ€§å®ç°äº†é«˜æ•ˆã€ç¨³å®šçš„ç ”å­¦å›¢ç»„ç®¡ç†ï¼š

### ğŸ¯ æ ¸å¿ƒç‰¹æ€§
1. **ç»Ÿä¸€æ•°æ®è§„èŒƒ**: camelCase å‘½å + Prisma æ˜ å°„ç¡®ä¿å‰åç«¯æ•°æ®ä¸€è‡´æ€§
2. **å®æ—¶æ•°æ®åŒæ­¥**: 800ms é˜²æŠ–è‡ªåŠ¨ä¿å­˜ + SQLite æŒä¹…åŒ–å­˜å‚¨
3. **æ™ºèƒ½ç»„ä»¶è®¾è®¡**: React.memo + useCallback + useMemo ä¼˜åŒ–æ€§èƒ½
4. **å®Œå–„é”™è¯¯å¤„ç†**: å‰åç«¯ç»Ÿä¸€é”™è¯¯æ‹¦æˆª + ç”¨æˆ·å‹å¥½æç¤º
5. **ç°ä»£åŒ– UI**: Ant Design + æ‹–æ‹½æ“ä½œ + å“åº”å¼å¸ƒå±€

### ğŸ”§ æŠ€æœ¯ä¼˜åŠ¿
- **æ•°æ®åº“æ¶æ„**: SQLite + Prisma ORM æä¾›å¼ºç±»å‹å®‰å…¨å’Œäº‹åŠ¡æ”¯æŒ
- **è‡ªåŠ¨ä¿å­˜æœºåˆ¶**: å‰ç«¯é˜²æŠ– + åç«¯äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸ä¸¢å¤±
- **ç»„ä»¶åŒ–æ¶æ„**: é«˜å†…èšä½è€¦åˆçš„ç»„ä»¶è®¾è®¡ä¾¿äºç»´æŠ¤æ‰©å±•
- **æ€§èƒ½ä¼˜åŒ–**: ç¼“å­˜ç­–ç•¥ + è™šæ‹Ÿæ»šåŠ¨ + è¯·æ±‚å»é‡
- **å¼€å‘ä½“éªŒ**: è¯¦ç»†æ—¥å¿— + é”™è¯¯è¾¹ç•Œ + è°ƒè¯•å·¥å…·

### ğŸš€ æ‰©å±•èƒ½åŠ›
- **æ°´å¹³æ‰©å±•**: Docker å®¹å™¨åŒ–æ”¯æŒ
- **åŠŸèƒ½æ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡ä¾¿äºæ–°åŠŸèƒ½å¼€å‘
- **é›†æˆèƒ½åŠ›**: RESTful API æ”¯æŒç¬¬ä¸‰æ–¹é›†æˆ
- **åä½œåŠŸèƒ½**: é¢„ç•™ WebSocket å®æ—¶åä½œæ¥å£

é€šè¿‡æœ¬æ–‡æ¡£çš„è¯¦ç»†è¯´æ˜ï¼Œå¼€å‘è€…å¯ä»¥å…¨é¢ç†è§£ç³»ç»Ÿçš„æ¶æ„è®¾è®¡ã€æ•°æ®æµè½¬ã€API æ¥å£ã€ç»„ä»¶äº¤äº’ç­‰å„ä¸ªæ–¹é¢ï¼Œä¸ºåç»­çš„åŠŸèƒ½å¼€å‘å’Œç³»ç»Ÿç»´æŠ¤æä¾›å®Œæ•´çš„æŠ€æœ¯å‚è€ƒã€‚